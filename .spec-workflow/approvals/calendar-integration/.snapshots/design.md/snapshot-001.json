{
  "id": "snapshot_1769401934232_n67no0m13",
  "approvalId": "approval_1769401934201_tdw62r11c",
  "approvalTitle": "calendar-integration Design",
  "version": 1,
  "timestamp": "2026-01-26T04:32:14.232Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document - calendar-integration\n\n## Overview\n\nカレンダー統合機能の技術設計。Google Calendar API（OAuth 2.0）とiCal URL取り込みを実装し、複数カレンダーからのイベント取得・キャッシュ・同期を提供する。DDD + 関数型プログラミングのアーキテクチャに従い、ドメイン層とインフラ層を分離する。\n\n## Steering Document Alignment\n\n### Technical Standards (CLAUDE.md)\n\n- **Mastraのレールに乗る**: カレンダーToolはMastra Toolsとして実装（将来のAI連携用）\n- **セキュリティ**: OAuth トークンは keytar で macOS Keychain に保存\n- **DDD + 関数型**: Result型、イミュータブル、レイヤー分離\n\n### Project Structure (CLAUDE.md)\n\n```\nlib/\n├── domain/calendar/          # カレンダードメイン層\n├── application/calendar/     # ユースケース層\n├── infrastructure/calendar/  # Google/iCal実装\n└── mastra/tools/calendar.ts  # Mastra Tool定義\n```\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **`lib/domain/shared/result.ts`**: Result<T, E>型でエラーハンドリング\n- **`lib/domain/shared/option.ts`**: Option<T>型で値の有無を表現\n- **`lib/domain/shared/types.ts`**: Brand型パターン（CalendarId等）\n- **`lib/infrastructure/keychain/`**: OAuth トークンの安全な保存\n- **`lib/infrastructure/db/`**: SQLiteキャッシュ用の接続管理\n- **`lib/config/`**: カレンダー設定の永続化\n\n### Integration Points\n\n- **Keychain**: `setSecret`, `getSecret` でOAuthトークン管理\n- **SQLite**: イベントキャッシュテーブル\n- **config.json**: `calendars[]` 配列でカレンダー設定保存\n\n## Architecture\n\n```mermaid\ngraph TD\n    subgraph \"Application Layer\"\n        UC1[AddGoogleCalendarUseCase]\n        UC2[AddICalCalendarUseCase]\n        UC3[GetEventsUseCase]\n        UC4[SyncCalendarsUseCase]\n    end\n\n    subgraph \"Domain Layer\"\n        CE[CalendarEvent Entity]\n        CP[CalendarProvider Interface]\n        CR[CalendarRepository Interface]\n        ER[EventRepository Interface]\n    end\n\n    subgraph \"Infrastructure Layer\"\n        GC[GoogleCalendarProvider]\n        IC[ICalProvider]\n        OA[OAuthService]\n        DB[SQLiteEventRepository]\n        KC[KeychainTokenStore]\n    end\n\n    UC1 --> CP\n    UC2 --> CP\n    UC3 --> ER\n    UC4 --> CP\n    UC4 --> ER\n\n    GC --> OA\n    GC --> KC\n    IC -.-> |HTTP fetch| ExtIcal[External iCal URL]\n    OA --> KC\n    DB --> SQLite[(SQLite)]\n```\n\n### Modular Design Principles\n\n- **Single File Responsibility**: プロバイダ（Google, iCal）は個別ファイル\n- **Component Isolation**: OAuth、イベント取得、キャッシュは独立サービス\n- **Service Layer Separation**: ドメイン層はインフラに依存しない\n- **Utility Modularity**: 日付計算、iCalパースは独立ユーティリティ\n\n## Components and Interfaces\n\n### Domain Layer\n\n#### CalendarEvent Entity\n\n- **Purpose**: カレンダーイベントを表現するエンティティ\n- **Location**: `lib/domain/calendar/event.ts`\n\n```typescript\ninterface CalendarEvent {\n  readonly id: EventId;\n  readonly calendarId: CalendarId;\n  readonly title: string;\n  readonly startTime: Date;\n  readonly endTime: Date;\n  readonly isAllDay: boolean;\n  readonly location: Option<string>;\n  readonly description: Option<string>;\n  readonly source: CalendarSource;\n}\n\ntype CalendarSource = {\n  readonly type: 'google' | 'ical';\n  readonly calendarName: string;\n  readonly accountEmail?: string;  // Google用\n};\n```\n\n#### CalendarProvider Interface\n\n- **Purpose**: カレンダープロバイダの抽象インターフェース\n- **Location**: `lib/domain/calendar/provider.ts`\n\n```typescript\ninterface CalendarProvider {\n  readonly type: 'google' | 'ical';\n\n  getCalendars(): Promise<Result<Calendar[], CalendarError>>;\n  getEvents(\n    calendarId: CalendarId,\n    range: TimeRange\n  ): Promise<Result<CalendarEvent[], CalendarError>>;\n}\n```\n\n#### Repository Interfaces\n\n- **Location**: `lib/domain/calendar/repository.ts`\n\n```typescript\ninterface CalendarRepository {\n  findAll(): Promise<Result<CalendarConfig[], ConfigError>>;\n  save(calendar: CalendarConfig): Promise<Result<void, ConfigError>>;\n  delete(id: CalendarId): Promise<Result<void, ConfigError>>;\n}\n\ninterface EventRepository {\n  findByRange(range: TimeRange): Promise<Result<CalendarEvent[], DbError>>;\n  saveMany(events: CalendarEvent[]): Promise<Result<void, DbError>>;\n  deleteByCalendar(calendarId: CalendarId): Promise<Result<void, DbError>>;\n  getLastSyncTime(calendarId: CalendarId): Promise<Result<Option<Date>, DbError>>;\n  updateLastSyncTime(calendarId: CalendarId, time: Date): Promise<Result<void, DbError>>;\n}\n```\n\n### Infrastructure Layer\n\n#### GoogleCalendarProvider\n\n- **Purpose**: Google Calendar APIとの通信\n- **Location**: `lib/infrastructure/calendar/google-provider.ts`\n- **Dependencies**: googleapis, keychain\n- **Reuses**: `lib/infrastructure/keychain/` (トークン管理)\n\n```typescript\nclass GoogleCalendarProvider implements CalendarProvider {\n  constructor(\n    private readonly tokenStore: TokenStore,\n    private readonly accountEmail: string\n  ) {}\n\n  // OAuth認証フロー開始\n  static startAuth(redirectUri: string): AuthUrl;\n\n  // 認証コード交換\n  static exchangeCode(code: string): Promise<Result<Tokens, AuthError>>;\n\n  // トークンリフレッシュ\n  private refreshTokenIfNeeded(): Promise<Result<void, AuthError>>;\n}\n```\n\n#### ICalProvider\n\n- **Purpose**: iCal URLからのイベント取得\n- **Location**: `lib/infrastructure/calendar/ical-provider.ts`\n- **Dependencies**: ical.js (パーサー)\n\n```typescript\nclass ICalProvider implements CalendarProvider {\n  constructor(\n    private readonly url: string,\n    private readonly name: string\n  ) {}\n\n  // URL有効性検証\n  static validateUrl(url: string): Promise<Result<ICalMeta, ICalError>>;\n}\n```\n\n#### OAuthService\n\n- **Purpose**: Google OAuth 2.0 PKCE フロー管理\n- **Location**: `lib/infrastructure/calendar/oauth-service.ts`\n\n```typescript\ninterface OAuthService {\n  // 認証URL生成（PKCE code_verifier含む）\n  generateAuthUrl(): { url: string; codeVerifier: string };\n\n  // コード交換\n  exchangeCode(\n    code: string,\n    codeVerifier: string\n  ): Promise<Result<OAuthTokens, AuthError>>;\n\n  // トークンリフレッシュ\n  refreshToken(\n    refreshToken: string\n  ): Promise<Result<OAuthTokens, AuthError>>;\n}\n\ninterface OAuthTokens {\n  readonly accessToken: string;\n  readonly refreshToken: string;\n  readonly expiresAt: Date;\n}\n```\n\n#### SQLiteEventRepository\n\n- **Purpose**: イベントキャッシュの永続化\n- **Location**: `lib/infrastructure/db/event-repository.ts`\n- **Reuses**: `lib/infrastructure/db/connection.ts`\n\n### Application Layer (Use Cases)\n\n#### AddGoogleCalendarUseCase\n\n- **Location**: `lib/application/calendar/add-google-calendar.ts`\n- **Flow**:\n  1. OAuth認証URL生成\n  2. コールバック待機\n  3. トークン交換・保存\n  4. カレンダー一覧取得\n  5. 設定に追加\n\n#### GetEventsUseCase\n\n- **Location**: `lib/application/calendar/get-events.ts`\n- **Flow**:\n  1. キャッシュ確認\n  2. 古い場合はAPI取得\n  3. 複数カレンダー統合・ソート\n\n#### SyncCalendarsUseCase\n\n- **Location**: `lib/application/calendar/sync-calendars.ts`\n- **Flow**:\n  1. 全有効カレンダー取得\n  2. 並列でイベント取得\n  3. キャッシュ更新\n  4. 同期時刻更新\n\n## Data Models\n\n### SQLite Schema\n\n```sql\n-- カレンダーイベントキャッシュ\nCREATE TABLE calendar_events (\n  id TEXT PRIMARY KEY,           -- eventId + calendarId のハッシュ\n  event_id TEXT NOT NULL,\n  calendar_id TEXT NOT NULL,\n  title TEXT NOT NULL,\n  start_time TEXT NOT NULL,      -- ISO8601\n  end_time TEXT NOT NULL,        -- ISO8601\n  is_all_day INTEGER NOT NULL,   -- 0 or 1\n  location TEXT,\n  description TEXT,\n  source_type TEXT NOT NULL,     -- 'google' | 'ical'\n  source_name TEXT NOT NULL,\n  source_account TEXT,           -- Google用メールアドレス\n  cached_at TEXT NOT NULL,       -- ISO8601\n  UNIQUE(event_id, calendar_id)\n);\n\n-- 同期状態\nCREATE TABLE calendar_sync_state (\n  calendar_id TEXT PRIMARY KEY,\n  last_sync_time TEXT NOT NULL,  -- ISO8601\n  sync_status TEXT NOT NULL      -- 'success' | 'error'\n);\n\n-- インデックス\nCREATE INDEX idx_events_range ON calendar_events(start_time, end_time);\nCREATE INDEX idx_events_calendar ON calendar_events(calendar_id);\n```\n\n### Config Schema (config.json拡張)\n\n```typescript\ninterface AppConfig {\n  // ... existing fields\n  calendars: CalendarConfig[];\n}\n\ninterface CalendarConfig {\n  readonly id: CalendarId;\n  readonly type: 'google' | 'ical';\n  readonly name: string;\n  readonly enabled: boolean;\n  readonly color?: string;\n\n  // Google固有\n  readonly googleAccountEmail?: string;\n  readonly googleCalendarId?: string;\n\n  // iCal固有\n  readonly icalUrl?: string;\n}\n```\n\n### Keychain Keys\n\n```typescript\n// Google OAuthトークン（アカウント別）\ntype GoogleTokenKey = `google-oauth-${accountEmail}`;\n\n// 保存形式\ninterface StoredTokens {\n  accessToken: string;\n  refreshToken: string;\n  expiresAt: string;  // ISO8601\n}\n```\n\n## API Routes\n\n### OAuth Callback\n\n```typescript\n// GET /api/auth/google/callback?code=xxx&state=xxx\n// OAuth認証コールバック処理\n```\n\n### Calendar API\n\n```typescript\n// GET /api/calendars\n// カレンダー一覧取得\n\n// POST /api/calendars/google\n// Googleカレンダー追加開始（認証URL返却）\n\n// POST /api/calendars/ical\n// iCalカレンダー追加\n\n// DELETE /api/calendars/:id\n// カレンダー削除\n\n// POST /api/calendars/sync\n// 全カレンダー同期\n\n// GET /api/events?range=today|week\n// イベント取得\n```\n\n## Error Handling\n\n### Error Types\n\n```typescript\ntype CalendarError =\n  | { code: 'AUTH_REQUIRED'; message: string }\n  | { code: 'AUTH_EXPIRED'; message: string; accountEmail: string }\n  | { code: 'API_ERROR'; message: string; statusCode: number }\n  | { code: 'NETWORK_ERROR'; message: string }\n  | { code: 'PARSE_ERROR'; message: string }\n  | { code: 'NOT_FOUND'; message: string };\n```\n\n### Error Scenarios\n\n1. **OAuth トークン期限切れ**\n   - Handling: 自動リフレッシュ、失敗時は再認証要求\n   - User Impact: 通常は透過的、失敗時は「再認証が必要です」\n\n2. **iCal URL アクセス不可**\n   - Handling: キャッシュにフォールバック\n   - User Impact: 「最終更新: XX分前（同期エラー）」\n\n3. **ネットワークエラー**\n   - Handling: キャッシュから返却\n   - User Impact: 「オフラインモード」表示\n\n4. **Google API レート制限**\n   - Handling: 指数バックオフでリトライ\n   - User Impact: 同期が遅延する旨を表示\n\n## Dependencies\n\n### npm packages\n\n```json\n{\n  \"googleapis\": \"^144.0.0\",\n  \"ical.js\": \"^2.1.0\"\n}\n```\n\n- **googleapis**: Google Calendar API 公式クライアント\n- **ical.js**: iCalendar (RFC 5545) パーサー\n\n## Testing Strategy\n\n### Unit Testing\n\n- CalendarEvent値オブジェクトの生成・バリデーション\n- TimeRange計算（今日、今週の範囲）\n- iCalパース処理\n- Result型のエラーハンドリング\n\n### Integration Testing\n\n- SQLite EventRepository のCRUD\n- Keychain TokenStore のトークン保存・取得\n- OAuth トークンリフレッシュフロー\n\n### E2E Testing（手動）\n\n- Google OAuth認証フロー\n- 複数カレンダー追加・同期\n- オフライン時のキャッシュ動作\n\n## References\n\n- [Google Calendar API Quickstart (Node.js)](https://developers.google.com/workspace/calendar/api/quickstart/nodejs)\n- [Google OAuth 2.0 Documentation](https://developers.google.com/identity/protocols/oauth2)\n- [googleapis/google-api-nodejs-client](https://github.com/googleapis/google-api-nodejs-client)\n",
  "fileStats": {
    "size": 11914,
    "lines": 439,
    "lastModified": "2026-01-26T04:32:08.587Z"
  },
  "comments": []
}