{
  "id": "snapshot_1769402157456_sbs9alo8y",
  "approvalId": "approval_1769402091287_si9lvehaj",
  "approvalTitle": "calendar-integration Tasks",
  "version": 2,
  "timestamp": "2026-01-26T04:35:57.456Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Tasks Document - calendar-integration\n\n## 概要\n\nカレンダー統合機能の実装タスク。\n\n- Requirements: `.spec-workflow/specs/calendar-integration/requirements.md`\n- Design: `.spec-workflow/specs/calendar-integration/design.md`\n\n---\n\n## タスク一覧\n\n### Phase 1: ドメイン層\n\n- [ ] 1. カレンダードメイン型定義\n  - File: `lib/domain/calendar/types.ts`\n  - CalendarId, EventId, CalendarSource, TimeRange等の値オブジェクト定義\n  - Purpose: カレンダードメインの型安全性確保\n  - _Leverage: `lib/domain/shared/types.ts`（Brand型パターン）_\n  - _Requirements: 4_\n  - _Prompt: Implement the task for spec calendar-integration, first run spec-workflow-guide to get the workflow guide then implement the task: Role: TypeScript/DDD開発者 | Task: `lib/domain/calendar/types.ts`を作成。CalendarId, EventId（Brand型）、CalendarSource（google/ical）、TimeRange（startDate, endDate）を定義。既存のBrand型パターンに従う | Restrictions: ドメイン層は他レイヤーに依存しない | Success: 型定義が完了し、他ファイルからimport可能_\n\n- [ ] 2. CalendarEventエンティティ実装\n  - File: `lib/domain/calendar/event.ts`\n  - CalendarEventエンティティとファクトリ関数\n  - Purpose: イベントデータの表現\n  - _Leverage: `lib/domain/calendar/types.ts`, `lib/domain/shared/option.ts`_\n  - _Requirements: 4_\n  - _Prompt: Implement the task for spec calendar-integration: Role: TypeScript/DDD開発者 | Task: `lib/domain/calendar/event.ts`を作成。CalendarEvent interface（id, calendarId, title, startTime, endTime, isAllDay, location: Option, description: Option, source）とcreateCalendarEvent()ファクトリ関数を実装 | Restrictions: イミュータブル、Option型使用 | Success: CalendarEventが生成・使用可能_\n\n- [ ] 3. リポジトリインターフェース定義\n  - File: `lib/domain/calendar/repository.ts`\n  - CalendarRepository, EventRepositoryインターフェース\n  - Purpose: データアクセスの抽象化\n  - _Leverage: `lib/domain/shared/result.ts`_\n  - _Requirements: 5_\n  - _Prompt: Implement the task for spec calendar-integration: Role: TypeScript/DDD開発者 | Task: `lib/domain/calendar/repository.ts`を作成。CalendarRepository（findAll, save, delete）とEventRepository（findByRange, saveMany, deleteByCalendar, getLastSyncTime, updateLastSyncTime）をResult型で定義 | Restrictions: インターフェースのみ、実装はインフラ層 | Success: リポジトリ契約が明確に定義される_\n\n- [ ] 4. カレンダープロバイダインターフェース\n  - File: `lib/domain/calendar/provider.ts`\n  - CalendarProviderインターフェースと共通エラー型\n  - Purpose: Google/iCalプロバイダの抽象化\n  - _Leverage: `lib/domain/shared/result.ts`, `lib/domain/calendar/types.ts`_\n  - _Requirements: 1, 3_\n  - _Prompt: Implement the task for spec calendar-integration: Role: TypeScript/DDD開発者 | Task: `lib/domain/calendar/provider.ts`を作成。CalendarProvider interface（type, getCalendars, getEvents）とCalendarError型（AUTH_REQUIRED, AUTH_EXPIRED, API_ERROR, NETWORK_ERROR, PARSE_ERROR, NOT_FOUND）を定義 | Restrictions: インターフェースのみ | Success: プロバイダ抽象が完成_\n\n- [ ] 5. ドメイン層index.tsエクスポート\n  - File: `lib/domain/calendar/index.ts`\n  - カレンダードメインの公開API\n  - Purpose: モジュール境界の明確化\n  - _Leverage: Phase 1の全ファイル_\n  - _Requirements: NFR-Modularity_\n  - _Prompt: Implement the task for spec calendar-integration: Role: TypeScript開発者 | Task: `lib/domain/calendar/index.ts`を作成。types, event, repository, providerから必要な型・関数をエクスポート | Success: `import { CalendarEvent, CalendarProvider } from '@/lib/domain/calendar'`が動作_\n\n### Phase 2: インフラ層（データベース）\n\n- [ ] 6. SQLiteスキーマ・マイグレーション\n  - File: `lib/infrastructure/db/migrations/001_calendar_events.ts`\n  - calendar_events, calendar_sync_stateテーブル作成\n  - Purpose: イベントキャッシュ用スキーマ\n  - _Leverage: `lib/infrastructure/db/connection.ts`_\n  - _Requirements: 5_\n  - _Prompt: Implement the task for spec calendar-integration: Role: SQLite/TypeScript開発者 | Task: マイグレーションファイルを作成。calendar_events（id, event_id, calendar_id, title, start_time, end_time, is_all_day, location, description, source_type, source_name, source_account, cached_at）とcalendar_sync_state（calendar_id, last_sync_time, sync_status）テーブル、インデックス作成 | Success: テーブルが作成される_\n\n- [ ] 7. EventRepository実装\n  - File: `lib/infrastructure/db/event-repository.ts`\n  - SQLiteを使用したEventRepositoryの実装\n  - Purpose: イベントキャッシュのCRUD\n  - _Leverage: `lib/infrastructure/db/connection.ts`, `lib/domain/calendar/repository.ts`_\n  - _Requirements: 5_\n  - _Prompt: Implement the task for spec calendar-integration: Role: TypeScript/SQLite開発者 | Task: EventRepositoryインターフェースを実装。findByRange（TimeRangeでクエリ）、saveMany（バルクInsert/Replace）、deleteByCalendar、getLastSyncTime、updateLastSyncTimeをResult型で実装 | Restrictions: better-sqlite3使用、同期API | Success: イベントのキャッシュ読み書きが動作_\n\n### Phase 3: インフラ層（OAuth・プロバイダ）\n\n- [ ] 8. OAuthサービス実装\n  - File: `lib/infrastructure/calendar/oauth-service.ts`\n  - Google OAuth 2.0 PKCE フロー\n  - Purpose: 認証フロー管理\n  - _Leverage: `lib/infrastructure/keychain/`_\n  - _Requirements: 1_\n  - _Prompt: Implement the task for spec calendar-integration: Role: OAuth/TypeScript開発者 | Task: OAuthServiceを実装。generateAuthUrl()でPKCE code_verifier生成、exchangeCode()でトークン交換、refreshToken()でリフレッシュ。環境変数からGOOGLE_CLIENT_IDを読み込み。Result型使用 | Restrictions: PKCEフロー、googleapis使用 | Success: 認証URLが生成され、コード交換が動作_\n\n- [ ] 9. Keychainトークンストア\n  - File: `lib/infrastructure/calendar/token-store.ts`\n  - OAuthトークンのKeychain保存・取得\n  - Purpose: トークンの安全な永続化\n  - _Leverage: `lib/infrastructure/keychain/`_\n  - _Requirements: 1_\n  - _Prompt: Implement the task for spec calendar-integration: Role: TypeScript/セキュリティ開発者 | Task: TokenStoreを実装。saveTokens(accountEmail, tokens)、getTokens(accountEmail)、deleteTokens(accountEmail)。Keychainキーは`google-oauth-${email}`形式。JSON.stringify/parseでトークンをシリアライズ | Success: トークンがKeychainに保存・取得可能_\n\n- [ ] 10. GoogleCalendarProvider実装\n  - File: `lib/infrastructure/calendar/google-provider.ts`\n  - Google Calendar API連携\n  - Purpose: Googleカレンダーからのデータ取得\n  - _Leverage: `lib/domain/calendar/provider.ts`, googleapis_\n  - _Requirements: 1, 2, 4_\n  - _Prompt: Implement the task for spec calendar-integration: Role: Google API/TypeScript開発者 | Task: GoogleCalendarProviderを実装。getCalendars()でカレンダー一覧取得、getEvents()でイベント取得。トークン期限切れ時は自動リフレッシュ。calendar.readonly スコープのみ | Restrictions: googleapis使用、エラーはResult型 | Success: Googleカレンダーのイベントが取得可能_\n\n- [ ] 11. iCalProvider実装\n  - File: `lib/infrastructure/calendar/ical-provider.ts`\n  - iCal URLからのイベント取得\n  - Purpose: iCalカレンダーのパース・取得\n  - _Leverage: `lib/domain/calendar/provider.ts`, ical.js_\n  - _Requirements: 3, 4_\n  - _Prompt: Implement the task for spec calendar-integration: Role: TypeScript開発者 | Task: ICalProviderを実装。validateUrl()でURL有効性確認、getEvents()でiCalをfetch→パース→CalendarEvent変換。ical.js使用 | Restrictions: HTTPSのみ、タイムアウト10秒 | Success: iCal URLからイベント取得可能_\n\n- [ ] 12. インフラ層カレンダーindex.ts\n  - File: `lib/infrastructure/calendar/index.ts`\n  - カレンダーインフラ層のエクスポート\n  - Purpose: モジュール境界\n  - _Leverage: Phase 3の全ファイル_\n  - _Requirements: NFR-Modularity_\n  - _Prompt: Implement the task for spec calendar-integration: Role: TypeScript開発者 | Task: OAuthService, TokenStore, GoogleCalendarProvider, ICalProviderをエクスポート | Success: インフラ層が利用可能_\n\n### Phase 4: アプリケーション層\n\n- [ ] 13. Config拡張（calendars配列）\n  - File: `lib/config/types.ts`（修正）\n  - CalendarConfig型とcalendars配列の追加\n  - Purpose: カレンダー設定の永続化\n  - _Leverage: 既存のlib/config/_\n  - _Requirements: 2, 3_\n  - _Prompt: Implement the task for spec calendar-integration: Role: TypeScript開発者 | Task: `lib/config/types.ts`にCalendarConfig（id, type, name, enabled, color?, googleAccountEmail?, googleCalendarId?, icalUrl?）を追加。AppConfigにcalendars: CalendarConfig[]を追加。Zodスキーマも更新 | Success: config.jsonにcalendarsが保存可能_\n\n- [ ] 14. AddGoogleCalendarユースケース\n  - File: `lib/application/calendar/add-google-calendar.ts`\n  - Googleカレンダー追加フロー\n  - Purpose: OAuth→カレンダー登録の統合\n  - _Leverage: インフラ層のOAuthService, GoogleCalendarProvider_\n  - _Requirements: 1, 2_\n  - _Prompt: Implement the task for spec calendar-integration: Role: TypeScript開発者 | Task: startGoogleAuth()で認証URL生成、completeGoogleAuth(code, codeVerifier)でトークン交換→カレンダー一覧取得→設定保存 | Success: Googleカレンダーが追加可能_\n\n- [ ] 15. AddICalCalendarユースケース\n  - File: `lib/application/calendar/add-ical-calendar.ts`\n  - iCalカレンダー追加\n  - Purpose: iCal URL登録\n  - _Leverage: ICalProvider_\n  - _Requirements: 3_\n  - _Prompt: Implement the task for spec calendar-integration: Role: TypeScript開発者 | Task: addICalCalendar(url, name?)を実装。URL検証→カレンダー名抽出（または入力）→設定保存 | Success: iCalカレンダーが追加可能_\n\n- [ ] 16. GetEventsユースケース\n  - File: `lib/application/calendar/get-events.ts`\n  - イベント取得（キャッシュ優先）\n  - Purpose: 今日/今週のイベント統合取得\n  - _Leverage: EventRepository, CalendarProviders_\n  - _Requirements: 4, 5_\n  - _Prompt: Implement the task for spec calendar-integration: Role: TypeScript開発者 | Task: getEventsForToday()、getEventsForWeek()を実装。キャッシュ確認→古ければAPI取得→ソート→統合 | Success: 今日/今週のイベントが取得可能_\n\n- [ ] 17. SyncCalendarsユースケース\n  - File: `lib/application/calendar/sync-calendars.ts`\n  - カレンダー同期\n  - Purpose: 全カレンダーの更新\n  - _Leverage: EventRepository, CalendarProviders_\n  - _Requirements: 6_\n  - _Prompt: Implement the task for spec calendar-integration: Role: TypeScript開発者 | Task: syncAllCalendars()を実装。有効カレンダー取得→並列イベント取得→キャッシュ更新→同期時刻更新。エラーカレンダーの特定 | Success: 同期が実行可能_\n\n- [ ] 18. アプリケーション層index.ts\n  - File: `lib/application/calendar/index.ts`\n  - カレンダーユースケースのエクスポート\n  - Purpose: モジュール境界\n  - _Leverage: Phase 4のユースケース_\n  - _Requirements: NFR-Modularity_\n  - _Prompt: Implement the task for spec calendar-integration: Role: TypeScript開発者 | Task: 全ユースケースをエクスポート | Success: アプリケーション層が利用可能_\n\n### Phase 5: API Routes\n\n- [ ] 19. OAuth Callback API\n  - File: `app/api/auth/google/callback/route.ts`\n  - Google OAuth コールバック処理\n  - Purpose: 認証完了処理\n  - _Leverage: AddGoogleCalendarユースケース_\n  - _Requirements: 1_\n  - _Prompt: Implement the task for spec calendar-integration: Role: Next.js開発者 | Task: GET /api/auth/google/callback を実装。code, state取得→completeGoogleAuth呼び出し→成功時リダイレクト | Success: OAuth認証が完了する_\n\n- [ ] 20. Calendars API\n  - File: `app/api/calendars/route.ts`, `app/api/calendars/[id]/route.ts`\n  - カレンダーCRUD API\n  - Purpose: カレンダー管理エンドポイント\n  - _Leverage: ユースケース層_\n  - _Requirements: 2, 3_\n  - _Prompt: Implement the task for spec calendar-integration: Role: Next.js開発者 | Task: GET /api/calendars（一覧）、POST /api/calendars/google（追加開始）、POST /api/calendars/ical（iCal追加）、DELETE /api/calendars/:id（削除） | Success: カレンダー管理APIが動作_\n\n- [ ] 21. Events API\n  - File: `app/api/events/route.ts`\n  - イベント取得API\n  - Purpose: 今日/今週のイベント取得\n  - _Leverage: GetEventsユースケース_\n  - _Requirements: 4_\n  - _Prompt: Implement the task for spec calendar-integration: Role: Next.js開発者 | Task: GET /api/events?range=today|week を実装 | Success: イベントがJSON取得可能_\n\n- [ ] 22. Sync API\n  - File: `app/api/calendars/sync/route.ts`\n  - 同期API\n  - Purpose: 手動同期トリガー\n  - _Leverage: SyncCalendarsユースケース_\n  - _Requirements: 6_\n  - _Prompt: Implement the task for spec calendar-integration: Role: Next.js開発者 | Task: POST /api/calendars/sync を実装 | Success: 同期がトリガー可能_\n\n---\n\n## 依存関係\n\n```\nPhase 1 (ドメイン層)\n  └─> Phase 2 (DB)\n  └─> Phase 3 (OAuth/プロバイダ)\n        └─> Phase 4 (アプリケーション層)\n              └─> Phase 5 (API Routes)\n```\n\n## 実装順序\n\n1. **Phase 1** (タスク1-5): ドメイン層の型・インターフェース\n2. **Phase 2** (タスク6-7): SQLiteスキーマ・リポジトリ\n3. **Phase 3** (タスク8-12): OAuth・プロバイダ実装\n4. **Phase 4** (タスク13-18): ユースケース実装\n5. **Phase 5** (タスク19-22): API Routes\n\n---\n\n## 完了基準\n\n- すべてのタスクが完了していること\n- `npm run build` が成功すること\n- `npx biome check .` でエラーがないこと\n- Googleカレンダー追加のOAuthフローが動作すること\n- iCal URL追加が動作すること\n- 今日/今週のイベント取得が動作すること\n- イベントがSQLiteにキャッシュされること\n",
  "fileStats": {
    "size": 14623,
    "lines": 231,
    "lastModified": "2026-01-26T04:34:44.864Z"
  },
  "comments": []
}