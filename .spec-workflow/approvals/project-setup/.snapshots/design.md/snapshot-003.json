{
	"id": "snapshot_1769384922004_vqy03wth4",
	"approvalId": "approval_1769384803681_2hf46l14n",
	"approvalTitle": "project-setup Design Document（ライブラリバージョン更新版）",
	"version": 3,
	"timestamp": "2026-01-25T23:48:42.004Z",
	"trigger": "revision_requested",
	"status": "pending",
	"content": "# Design Document - project-setup\n\n## Overview\n\n本文書は、miipaプロジェクトの初期セットアップに関する設計を定義する。Next.js (App Router) + Mastra + Panda CSS + Biome を用いた開発環境の構築、DDDレイヤーアーキテクチャ、関数型プログラミングの基盤型（Result型、Option型）の設計を含む。\n\nmiipaは一人社長向けのカレンダー統合AIアシスタントであり、「今日/今週の自分を30秒で把握」できるローカル実行ツールを目指す。本セットアップでは、その基盤となるプロジェクト構造と型システムを構築する。\n\n## 使用ライブラリバージョン（2026年1月時点）\n\n本プロジェクトで使用する主要ライブラリの最新バージョンを以下に明示する。\n\n| ライブラリ | バージョン | 備考 |\n|-----------|-----------|------|\n| Next.js | 16.1.x | Turbopack File System Caching (stable)、Cache Components、React Compiler対応 |\n| React | 19.2.x | `<Activity>`、`useEffectEvent`、View Transitions対応 |\n| TypeScript | 5.9.x (stable) / 6.0.x (bridge) | 7.0 (Go-based native compiler) は2026年前半リリース予定 |\n| Panda CSS | 0.50.x | 型安全なCSS-in-JS、ビルド時CSS生成 |\n| Park UI | 0.43.x | Ark UI 3.0 API対応、Panda CSS Preset |\n| Biome | 2.3.x | 425以上のlintルール、type-aware linting対応 |\n| Mastra | 0.3.x → 1.0.x | v1.0は2026年1月リリース予定、AI SDK v6 beta対応 |\n| better-sqlite3 | 12.6.x | Node.js v14.21.1以降対応、LTS版向けprebuilt binaries |\n| keytar | 7.9.0 | macOS Keychain統合（最終更新: 2021年、安定版） |\n\n### バージョン選定方針\n\n- **安定性優先**: プロダクション利用を前提に、RC/betaよりも安定版を優先\n- **セキュリティ**: セキュリティパッチが提供されるLTS/最新安定版を使用\n- **互換性**: Next.js 16とReact 19.2の組み合わせを基準に依存関係を調整\n\n### 注意事項\n\n- TypeScript 7.0（Go-based native compiler）は2026年前半リリース予定。初期開発では5.9.x系を使用し、7.0リリース後に移行を検討\n- Mastra v1.0のGAリリースを待って本格導入。開発開始時点ではv0.3.x系で構築\n- keytarは長期間更新がないが、macOS Keychain統合としては安定しており継続使用\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\n本設計は以下の技術標準に従う:\n\n- **TypeScript**: strict モード有効、型安全性を最優先\n- **関数型プログラミング**: Result/Option型による明示的なエラーハンドリング\n- **DDD**: ドメイン層をインフラ層から分離、リポジトリパターンの採用\n- **コーディング規約**: Biome による一貫したスタイル強制\n\n### Project Structure (structure.md)\n\nCLAUDE.md で定義されたディレクトリ構成に準拠:\n\n```\nmiipa/\n├── app/                    # Next.js App Router\n├── lib/\n│   ├── domain/            # ドメイン層\n│   ├── application/       # アプリケーション層\n│   ├── infrastructure/    # インフラ層\n│   ├── mastra/           # Mastra AI 統合\n│   └── config/           # 設定管理\n└── components/           # UI コンポーネント\n```\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n本プロジェクトは新規セットアップのため、外部ライブラリの活用を中心に設計する:\n\n- **Next.js 15**: App Router、Server Components、API Routes\n- **Mastra**: AI エージェント基盤（Vercel AI SDK ベース）\n- **Panda CSS**: 型安全な CSS-in-JS\n- **Park UI**: アクセシブルなUIコンポーネントプリセット\n- **keytar**: macOS Keychain 統合\n- **better-sqlite3**: 軽量SQLiteドライバ\n\n### Integration Points\n\n- **ファイルシステム**: `~/.miipa/` ディレクトリでの設定・データ永続化\n- **macOS Keychain**: keytar を介した機密情報管理\n- **LLM プロバイダ**: Mastra 経由での Claude/OpenAI/Ollama 接続\n\n## Architecture\n\n### アーキテクチャ概要\n\n本設計では、DDDに基づくレイヤードアーキテクチャと関数型プログラミングの原則を組み合わせる。\n\n```mermaid\ngraph TB\n    subgraph \"プレゼンテーション層\"\n        UI[UI Components]\n        Pages[Next.js Pages]\n        API[API Routes]\n    end\n\n    subgraph \"アプリケーション層\"\n        UseCase[Use Cases]\n        AppService[Application Services]\n    end\n\n    subgraph \"ドメイン層\"\n        Entity[Entities]\n        VO[Value Objects]\n        Aggregate[Aggregates]\n        DomainService[Domain Services]\n        RepoInterface[Repository Interfaces]\n        SharedTypes[Shared Types<br/>Result / Option]\n    end\n\n    subgraph \"インフラ層\"\n        RepoImpl[Repository Implementations]\n        ExternalAPI[External APIs<br/>Google Calendar / iCal]\n        DB[(SQLite)]\n        Keychain[macOS Keychain]\n    end\n\n    subgraph \"Mastra 統合\"\n        Agent[Mastra Agent]\n        Tools[Mastra Tools]\n        LLM[LLM Providers]\n    end\n\n    UI --> Pages\n    Pages --> API\n    API --> UseCase\n    UseCase --> AppService\n    AppService --> DomainService\n    AppService --> RepoInterface\n    DomainService --> Entity\n    DomainService --> VO\n    DomainService --> Aggregate\n    Entity --> SharedTypes\n    VO --> SharedTypes\n    RepoInterface --> SharedTypes\n    RepoImpl --> RepoInterface\n    RepoImpl --> DB\n    RepoImpl --> ExternalAPI\n    RepoImpl --> Keychain\n    API --> Agent\n    Agent --> Tools\n    Agent --> LLM\n    Tools --> AppService\n```\n\n### Modular Design Principles\n\n- **Single File Responsibility**: 各ファイルは単一の明確な目的を持つ\n  - 例: `result.ts` は Result 型のみ、`option.ts` は Option 型のみを定義\n- **Component Isolation**: 小さく焦点を絞ったコンポーネントを作成\n  - ドメインエンティティは独立したファイルに分離\n- **Service Layer Separation**: データアクセス、ビジネスロジック、プレゼンテーションを分離\n  - ドメイン層 → アプリケーション層 → プレゼンテーション層の一方向依存\n- **Utility Modularity**: ユーティリティは単一目的のモジュールに分割\n  - `shared/` 配下に共通型を集約\n\n### 依存関係の方向\n\n```mermaid\ngraph LR\n    Presentation[プレゼンテーション層] --> Application[アプリケーション層]\n    Application --> Domain[ドメイン層]\n    Infrastructure[インフラ層] --> Domain\n\n    style Domain fill:#e1f5fe\n    style Application fill:#fff3e0\n    style Presentation fill:#f3e5f5\n    style Infrastructure fill:#e8f5e9\n```\n\n**重要**: ドメイン層はいかなる他の層にも依存しない。インフラ層がドメイン層のインターフェースに依存する（依存性逆転の原則）。\n\n## Components and Interfaces\n\n### Component 1: Result 型 (`lib/domain/shared/result.ts`)\n\n**Purpose:** 成功/失敗を明示的に型で表現し、例外スローを避ける\n\n**Interfaces:**\n\n```typescript\n// 型定義\ntype Ok<T> = { readonly _tag: 'Ok'; readonly value: T };\ntype Err<E> = { readonly _tag: 'Err'; readonly error: E };\ntype Result<T, E> = Ok<T> | Err<E>;\n\n// コンストラクタ\nfunction ok<T>(value: T): Ok<T>;\nfunction err<E>(error: E): Err<E>;\n\n// 型ガード\nfunction isOk<T, E>(result: Result<T, E>): result is Ok<T>;\nfunction isErr<T, E>(result: Result<T, E>): result is Err<E>;\n\n// 変換関数\nfunction map<T, U, E>(result: Result<T, E>, fn: (value: T) => U): Result<U, E>;\nfunction flatMap<T, U, E>(result: Result<T, E>, fn: (value: T) => Result<U, E>): Result<U, E>;\nfunction mapErr<T, E, F>(result: Result<T, E>, fn: (error: E) => F): Result<T, F>;\n\n// 値の取り出し\nfunction unwrap<T, E>(result: Result<T, E>): T;  // Err の場合は例外\nfunction unwrapOr<T, E>(result: Result<T, E>, defaultValue: T): T;\nfunction unwrapErr<T, E>(result: Result<T, E>): E;  // Ok の場合は例外\n\n// パターンマッチング\nfunction match<T, E, U>(\n  result: Result<T, E>,\n  handlers: { ok: (value: T) => U; err: (error: E) => U }\n): U;\n\n// 複数Result の合成\nfunction all<T, E>(results: Result<T, E>[]): Result<T[], E>;\nfunction fromPromise<T, E = Error>(promise: Promise<T>): Promise<Result<T, E>>;\n```\n\n**Dependencies:** なし（純粋なユーティリティ型）\n\n**Reuses:** なし（基盤型として新規作成）\n\n### Component 2: Option 型 (`lib/domain/shared/option.ts`)\n\n**Purpose:** null/undefined の代わりに値の有無を型で表現する\n\n**Interfaces:**\n\n```typescript\n// 型定義\ntype Some<T> = { readonly _tag: 'Some'; readonly value: T };\ntype None = { readonly _tag: 'None' };\ntype Option<T> = Some<T> | None;\n\n// コンストラクタ\nfunction some<T>(value: T): Some<T>;\nfunction none(): None;\nfunction fromNullable<T>(value: T | null | undefined): Option<T>;\n\n// 型ガード\nfunction isSome<T>(option: Option<T>): option is Some<T>;\nfunction isNone<T>(option: Option<T>): option is None;\n\n// 変換関数\nfunction map<T, U>(option: Option<T>, fn: (value: T) => U): Option<U>;\nfunction flatMap<T, U>(option: Option<T>, fn: (value: T) => Option<U>): Option<U>;\nfunction filter<T>(option: Option<T>, predicate: (value: T) => boolean): Option<T>;\n\n// 値の取り出し\nfunction unwrap<T>(option: Option<T>): T;  // None の場合は例外\nfunction unwrapOr<T>(option: Option<T>, defaultValue: T): T;\nfunction unwrapOrElse<T>(option: Option<T>, fn: () => T): T;\n\n// パターンマッチング\nfunction match<T, U>(\n  option: Option<T>,\n  handlers: { some: (value: T) => U; none: () => U }\n): U;\n\n// Option と Result の変換\nfunction toResult<T, E>(option: Option<T>, error: E): Result<T, E>;\nfunction fromResult<T, E>(result: Result<T, E>): Option<T>;\n```\n\n**Dependencies:** `result.ts`（toResult/fromResult で相互変換）\n\n**Reuses:** なし（基盤型として新規作成）\n\n### Component 3: アプリケーションエラー型 (`lib/domain/shared/errors.ts`)\n\n**Purpose:** アプリケーション全体で使用する共通エラー型を定義\n\n**Interfaces:**\n\n```typescript\n// 基底エラー型\ninterface AppError {\n  readonly code: string;\n  readonly message: string;\n  readonly cause?: unknown;\n}\n\n// 設定関連エラー\ninterface ConfigError extends AppError {\n  readonly code: 'CONFIG_NOT_FOUND' | 'CONFIG_PARSE_ERROR' | 'CONFIG_VALIDATION_ERROR';\n}\n\n// ファイルシステムエラー\ninterface FileSystemError extends AppError {\n  readonly code: 'FILE_NOT_FOUND' | 'FILE_READ_ERROR' | 'FILE_WRITE_ERROR' | 'DIRECTORY_CREATE_ERROR';\n  readonly path: string;\n}\n\n// Keychain エラー\ninterface KeychainError extends AppError {\n  readonly code: 'KEYCHAIN_ACCESS_DENIED' | 'KEYCHAIN_NOT_FOUND' | 'KEYCHAIN_WRITE_ERROR';\n  readonly service: string;\n}\n\n// エラーファクトリ関数\nfunction configError(code: ConfigError['code'], message: string, cause?: unknown): ConfigError;\nfunction fileSystemError(code: FileSystemError['code'], path: string, message: string, cause?: unknown): FileSystemError;\nfunction keychainError(code: KeychainError['code'], service: string, message: string, cause?: unknown): KeychainError;\n```\n\n**Dependencies:** なし\n\n**Reuses:** なし\n\n### Component 4: 設定管理 (`lib/config/`)\n\n**Purpose:** アプリケーション設定の読み込み・保存を管理\n\n**ファイル構成:**\n\n```\nlib/config/\n├── index.ts              # 公開API（re-export）\n├── types.ts              # 設定の型定義\n├── loader.ts             # 設定ファイルの読み込み\n├── validator.ts          # 設定の検証\n└── paths.ts              # パス定数\n```\n\n**Interfaces:**\n\n```typescript\n// lib/config/types.ts\ninterface AppConfig {\n  readonly version: string;\n  readonly llm: LLMConfig;\n  readonly calendars: CalendarConfig[];\n}\n\ninterface LLMConfig {\n  readonly provider: 'claude' | 'openai' | 'ollama';\n  readonly model?: string;\n}\n\ninterface CalendarConfig {\n  readonly id: string;\n  readonly name: string;\n  readonly type: 'google' | 'ical';\n  readonly url?: string;  // iCal の場合\n}\n\n// lib/config/loader.ts\nfunction loadConfig(): Promise<Result<AppConfig, ConfigError>>;\nfunction saveConfig(config: AppConfig): Promise<Result<void, ConfigError>>;\nfunction initializeConfig(): Promise<Result<AppConfig, ConfigError>>;\n\n// lib/config/paths.ts\nconst MIIPA_DIR: string;  // ~/.miipa\nconst CONFIG_PATH: string;  // ~/.miipa/config.json\nconst DB_PATH: string;      // ~/.miipa/db.sqlite\n```\n\n**Dependencies:**\n- `lib/domain/shared/result.ts`\n- `lib/domain/shared/errors.ts`\n\n### Component 5: Keychain 統合 (`lib/infrastructure/keychain/`)\n\n**Purpose:** macOS Keychain を介した機密情報の安全な管理\n\n**ファイル構成:**\n\n```\nlib/infrastructure/keychain/\n├── index.ts              # 公開API\n├── types.ts              # 型定義\n└── keytar-adapter.ts     # keytar ラッパー\n```\n\n**Interfaces:**\n\n```typescript\n// lib/infrastructure/keychain/types.ts\ntype SecretKey = 'google-oauth-token' | 'openai-api-key' | 'anthropic-api-key';\n\n// lib/infrastructure/keychain/index.ts\nfunction getSecret(key: SecretKey): Promise<Result<Option<string>, KeychainError>>;\nfunction setSecret(key: SecretKey, value: string): Promise<Result<void, KeychainError>>;\nfunction deleteSecret(key: SecretKey): Promise<Result<void, KeychainError>>;\n```\n\n**Dependencies:**\n- `keytar` (npm パッケージ)\n- `lib/domain/shared/result.ts`\n- `lib/domain/shared/option.ts`\n- `lib/domain/shared/errors.ts`\n\n### Component 6: Mastra Agent 基盤 (`lib/mastra/`)\n\n**Purpose:** AI エージェントの基盤設定\n\n**ファイル構成:**\n\n```\nlib/mastra/\n├── index.ts              # Mastra インスタンス初期化\n├── agent.ts              # Agent 定義\n└── tools/\n    └── index.ts          # Tools エクスポート\n```\n\n**Interfaces:**\n\n```typescript\n// lib/mastra/index.ts\nimport { Mastra } from '@mastra/core';\n\nexport const mastra: Mastra;\n\n// lib/mastra/agent.ts\nimport { Agent } from '@mastra/core';\n\nexport const miipaAgent: Agent;\n```\n\n**Dependencies:**\n- `@mastra/core`\n- `lib/config/` (LLM 設定の読み込み)\n\n### Component 7: データベース基盤 (`lib/infrastructure/db/`)\n\n**Purpose:** SQLite データベースの初期化と基本操作\n\n**ファイル構成:**\n\n```\nlib/infrastructure/db/\n├── index.ts              # DB 初期化・接続管理\n├── types.ts              # 型定義\n└── migrations/\n    └── 001_initial.sql   # 初期スキーマ\n```\n\n**Interfaces:**\n\n```typescript\n// lib/infrastructure/db/index.ts\nimport Database from 'better-sqlite3';\n\nfunction initializeDatabase(): Result<Database, FileSystemError>;\nfunction getDatabase(): Option<Database>;\nfunction closeDatabase(): void;\n```\n\n**Dependencies:**\n- `better-sqlite3`\n- `lib/config/paths.ts`\n- `lib/domain/shared/result.ts`\n- `lib/domain/shared/option.ts`\n\n## Data Models\n\n### Model 1: AppConfig（アプリケーション設定）\n\n```typescript\ninterface AppConfig {\n  readonly version: string;           // 設定ファイルバージョン (例: \"1.0.0\")\n  readonly llm: LLMConfig;            // LLM プロバイダ設定\n  readonly calendars: CalendarConfig[]; // カレンダー設定リスト\n  readonly ui: UIConfig;              // UI 設定\n}\n\ninterface LLMConfig {\n  readonly provider: 'claude' | 'openai' | 'ollama';\n  readonly model?: string;            // モデル名（省略時はプロバイダデフォルト）\n  readonly baseUrl?: string;          // Ollama 用カスタムURL\n}\n\ninterface CalendarConfig {\n  readonly id: string;                // 一意識別子 (UUID)\n  readonly name: string;              // 表示名\n  readonly type: 'google' | 'ical';   // カレンダータイプ\n  readonly enabled: boolean;          // 有効/無効\n  readonly color?: string;            // 表示色\n  readonly url?: string;              // iCal URL（type='ical' の場合）\n  readonly googleAccountId?: string;  // Google アカウントID（type='google' の場合）\n}\n\ninterface UIConfig {\n  readonly theme: 'light' | 'dark' | 'system';\n  readonly locale: 'ja' | 'en';\n}\n```\n\n**保存場所:** `~/.miipa/config.json`\n\n### Model 2: 共有型定義\n\n```typescript\n// lib/domain/shared/types.ts\n\n// ブランド型（型安全なID）\ntype Brand<K, T> = K & { readonly __brand: T };\n\ntype CalendarId = Brand<string, 'CalendarId'>;\ntype EventId = Brand<string, 'EventId'>;\n\n// 時間関連\ninterface TimeRange {\n  readonly start: Date;\n  readonly end: Date;\n}\n\ntype DateRange = 'today' | 'this-week' | 'this-month' | TimeRange;\n\n// ユーティリティ型\ntype NonEmptyArray<T> = [T, ...T[]];\n```\n\n## Error Handling\n\n### Error Handling Strategy\n\n本プロジェクトでは、**例外をスローしない**関数型アプローチを採用する。\n\n```mermaid\ngraph LR\n    Operation[操作実行] --> Result{Result<T, E>}\n    Result -->|Ok| Success[成功処理]\n    Result -->|Err| ErrorHandle[エラーハンドリング]\n    ErrorHandle --> Log[ログ記録]\n    ErrorHandle --> UserFeedback[ユーザー通知]\n    ErrorHandle --> Recovery[リカバリー処理]\n```\n\n### Error Scenarios\n\n#### 1. 設定ファイル読み込みエラー\n\n**Scenario:** `~/.miipa/config.json` が存在しない、または破損している\n\n**Handling:**\n```typescript\nconst configResult = await loadConfig();\nmatch(configResult, {\n  ok: (config) => initializeApp(config),\n  err: (error) => {\n    switch (error.code) {\n      case 'CONFIG_NOT_FOUND':\n        // デフォルト設定で初期化\n        return initializeConfig();\n      case 'CONFIG_PARSE_ERROR':\n        // バックアップを試行、ユーザーに警告\n        return recoverFromBackup();\n      case 'CONFIG_VALIDATION_ERROR':\n        // 検証エラーをユーザーに表示\n        return showValidationErrors(error);\n    }\n  }\n});\n```\n\n**User Impact:** 初回起動時はセットアップウィザードを表示。破損時は警告とリカバリー選択肢を提示。\n\n#### 2. Keychain アクセスエラー\n\n**Scenario:** macOS Keychain へのアクセスが拒否された\n\n**Handling:**\n```typescript\nconst secretResult = await getSecret('google-oauth-token');\nmatch(secretResult, {\n  ok: (optionSecret) =>\n    match(optionSecret, {\n      some: (secret) => useSecret(secret),\n      none: () => promptForCredentials()\n    }),\n  err: (error) => {\n    if (error.code === 'KEYCHAIN_ACCESS_DENIED') {\n      // システム環境設定を開くよう案内\n      showKeychainPermissionGuide();\n    }\n  }\n});\n```\n\n**User Impact:** Keychain 権限の設定方法を案内するダイアログを表示。\n\n#### 3. データベース初期化エラー\n\n**Scenario:** SQLite データベースの作成・接続に失敗\n\n**Handling:**\n```typescript\nconst dbResult = initializeDatabase();\nmatch(dbResult, {\n  ok: (db) => startApp(db),\n  err: (error) => {\n    // ディレクトリ作成の再試行\n    const dirResult = await ensureDirectory(MIIPA_DIR);\n    if (isErr(dirResult)) {\n      showFatalError('データ保存先を作成できません', error);\n      process.exit(1);\n    }\n    // 再試行\n    return initializeDatabase();\n  }\n});\n```\n\n**User Impact:** 致命的エラーの場合は明確なエラーメッセージと解決策を表示。\n\n#### 4. LLM プロバイダ接続エラー\n\n**Scenario:** Claude/OpenAI/Ollama への接続に失敗\n\n**Handling:**\n```typescript\nconst responseResult = await agent.generate(prompt);\nmatch(responseResult, {\n  ok: (response) => displayResponse(response),\n  err: (error) => {\n    // フォールバック: 別プロバイダを試行（設定されている場合）\n    // または、オフラインモードで基本機能のみ提供\n    showOfflineMode();\n  }\n});\n```\n\n**User Impact:** 接続エラー時はオフラインモードで基本的なカレンダー表示のみ提供。\n\n## Testing Strategy\n\n### Unit Testing\n\n**対象:**\n- `lib/domain/shared/result.ts` - Result 型の全ユーティリティ関数\n- `lib/domain/shared/option.ts` - Option 型の全ユーティリティ関数\n- `lib/config/validator.ts` - 設定バリデーション\n- 純粋関数全般\n\n**フレームワーク:** Vitest\n\n**テスト例:**\n```typescript\n// result.test.ts\nimport { describe, it, expect } from 'vitest';\nimport { ok, err, isOk, isErr, map, flatMap, match } from './result';\n\ndescribe('Result', () => {\n  describe('map', () => {\n    it('Ok の場合は関数を適用する', () => {\n      const result = ok(5);\n      const mapped = map(result, (x) => x * 2);\n      expect(isOk(mapped) && mapped.value).toBe(10);\n    });\n\n    it('Err の場合はそのまま返す', () => {\n      const result = err('error');\n      const mapped = map(result, (x: number) => x * 2);\n      expect(isErr(mapped) && mapped.error).toBe('error');\n    });\n  });\n\n  describe('match', () => {\n    it('Ok の場合は ok ハンドラを呼ぶ', () => {\n      const result = ok(5);\n      const value = match(result, {\n        ok: (x) => `success: ${x}`,\n        err: (e) => `error: ${e}`\n      });\n      expect(value).toBe('success: 5');\n    });\n  });\n});\n```\n\n### Integration Testing\n\n**対象:**\n- `lib/config/loader.ts` - ファイルシステムとの統合\n- `lib/infrastructure/keychain/` - Keychain との統合\n- `lib/infrastructure/db/` - SQLite との統合\n\n**アプローチ:**\n- テスト用の一時ディレクトリを使用\n- モック Keychain（CI環境用）\n- テスト用 SQLite インメモリデータベース\n\n**テスト例:**\n```typescript\n// config-loader.test.ts\nimport { describe, it, expect, beforeEach, afterEach } from 'vitest';\nimport { mkdtemp, rm } from 'fs/promises';\nimport { tmpdir } from 'os';\nimport { join } from 'path';\nimport { loadConfig, saveConfig } from './loader';\nimport { isOk, isErr } from '../domain/shared/result';\n\ndescribe('Config Loader', () => {\n  let testDir: string;\n\n  beforeEach(async () => {\n    testDir = await mkdtemp(join(tmpdir(), 'miipa-test-'));\n    // テスト用のパスを設定\n  });\n\n  afterEach(async () => {\n    await rm(testDir, { recursive: true });\n  });\n\n  it('設定ファイルを保存して読み込める', async () => {\n    const config = { version: '1.0.0', llm: { provider: 'claude' }, calendars: [] };\n    const saveResult = await saveConfig(config);\n    expect(isOk(saveResult)).toBe(true);\n\n    const loadResult = await loadConfig();\n    expect(isOk(loadResult) && loadResult.value).toEqual(config);\n  });\n});\n```\n\n### End-to-End Testing\n\n**対象:**\n- 初回起動フロー\n- 設定ウィザード\n- カレンダー表示（モックデータ使用）\n\n**フレームワーク:** Playwright\n\n**テストシナリオ:**\n\n1. **初回起動テスト**\n   - アプリケーション起動\n   - セットアップウィザード表示確認\n   - LLM プロバイダ選択\n   - 設定保存確認\n\n2. **設定変更テスト**\n   - 設定画面遷移\n   - 値の変更\n   - 保存と反映確認\n\n## Directory Structure\n\n最終的なディレクトリ構成:\n\n```\nmiipa/\n├── app/\n│   ├── layout.tsx                 # ルートレイアウト\n│   ├── page.tsx                   # メイン画面\n│   ├── setup/\n│   │   └── page.tsx              # セットアップウィザード\n│   └── api/\n│       ├── calendar/\n│       │   └── route.ts          # カレンダー API\n│       ├── ask/\n│       │   └── route.ts          # AI 質問 API\n│       └── auth/\n│           └── callback/\n│               └── route.ts      # OAuth コールバック\n├── components/\n│   ├── ui/                       # Park UI ベースコンポーネント\n│   └── features/                 # 機能別コンポーネント\n├── lib/\n│   ├── domain/\n│   │   ├── shared/\n│   │   │   ├── result.ts         # Result<T, E> 型\n│   │   │   ├── option.ts         # Option<T> 型\n│   │   │   ├── errors.ts         # 共通エラー型\n│   │   │   └── types.ts          # 共通型定義\n│   │   └── calendar/\n│   │       ├── entities/         # エンティティ（将来実装）\n│   │       ├── value-objects/    # 値オブジェクト（将来実装）\n│   │       └── repository.ts     # リポジトリインターフェース（将来実装）\n│   ├── application/\n│   │   └── .gitkeep             # 将来のユースケース用\n│   ├── infrastructure/\n│   │   ├── keychain/\n│   │   │   ├── index.ts\n│   │   │   ├── types.ts\n│   │   │   └── keytar-adapter.ts\n│   │   ├── db/\n│   │   │   ├── index.ts\n│   │   │   ├── types.ts\n│   │   │   └── migrations/\n│   │   │       └── 001_initial.sql\n│   │   └── calendar/            # 将来実装\n│   │       ├── google.ts\n│   │       └── ical.ts\n│   ├── mastra/\n│   │   ├── index.ts\n│   │   ├── agent.ts\n│   │   └── tools/\n│   │       └── index.ts\n│   └── config/\n│       ├── index.ts\n│       ├── types.ts\n│       ├── loader.ts\n│       ├── validator.ts\n│       └── paths.ts\n├── styled-system/               # Panda CSS 生成ファイル\n├── public/\n│   └── meerkat.svg             # ミーアキャットアイコン\n├── biome.json\n├── panda.config.ts\n├── next.config.ts\n├── package.json\n├── tsconfig.json\n└── vitest.config.ts\n```\n\n## Implementation Notes\n\n### パッケージ依存関係\n\n```json\n{\n  \"dependencies\": {\n    \"next\": \"^16.1.0\",\n    \"react\": \"^19.2.0\",\n    \"react-dom\": \"^19.2.0\",\n    \"@mastra/core\": \"^0.3.3\",\n    \"@mastra/ai-sdk\": \"^0.3.3\",\n    \"@park-ui/panda-preset\": \"^0.43.1\",\n    \"@ark-ui/react\": \"^3.0.0\",\n    \"keytar\": \"^7.9.0\",\n    \"better-sqlite3\": \"^12.6.2\",\n    \"zod\": \"^3.24.0\"\n  },\n  \"devDependencies\": {\n    \"@biomejs/biome\": \"^2.3.0\",\n    \"@pandacss/dev\": \"^0.50.0\",\n    \"typescript\": \"^5.9.3\",\n    \"vitest\": \"^3.0.0\",\n    \"@playwright/test\": \"^1.50.0\",\n    \"@types/better-sqlite3\": \"^7.6.13\",\n    \"@types/node\": \"^22.0.0\",\n    \"@types/react\": \"^19.0.0\",\n    \"@types/react-dom\": \"^19.0.0\"\n  }\n}\n```\n\n### 初期化順序\n\n1. `~/.miipa/` ディレクトリの作成\n2. `config.json` の読み込み/初期化\n3. SQLite データベースの初期化\n4. Mastra Agent の初期化\n5. Next.js サーバーの起動\n\n### 設定ファイルの初期値\n\n```json\n{\n  \"version\": \"1.0.0\",\n  \"llm\": {\n    \"provider\": \"claude\"\n  },\n  \"calendars\": [],\n  \"ui\": {\n    \"theme\": \"system\",\n    \"locale\": \"ja\"\n  }\n}\n```\n",
	"fileStats": {
		"size": 26927,
		"lines": 862,
		"lastModified": "2026-01-25T23:46:35.261Z"
	},
	"comments": []
}
