{
	"id": "snapshot_1769395804836_cpsunuiwd",
	"approvalId": "approval_1769395701231_lgxjkahx7",
	"approvalTitle": "Onboarding Design Document",
	"version": 2,
	"timestamp": "2026-01-26T02:50:04.835Z",
	"trigger": "approved",
	"status": "pending",
	"content": "# Design Document - Onboarding\n\n## Overview\n\n本文書は、miipaの初回起動時セットアップ（オンボーディング）機能の設計を定義する。ユーザーがアプリケーションを初めて起動した際に、LLMプロバイダの選択からAPIキーの設定までを3ステップ以内で完了できる、シンプルで直感的なセットアップフローを提供する。\n\n「30秒で設定完了」を目標とし、一人社長が迷わずに使い始められるUXを最優先とする。\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\n本設計は以下の技術標準に従う:\n\n- **TypeScript**: strict モード有効、型安全性を最優先\n- **関数型プログラミング**: Result/Option型による明示的なエラーハンドリング\n- **DDD**: ドメイン層をインフラ層から分離\n- **コーディング規約**: Biome による一貫したスタイル強制\n- **UIライブラリ**: Park UI + Panda CSS によるアクセシブルなUI\n\n### Project Structure (structure.md)\n\nCLAUDE.md で定義されたディレクトリ構成に準拠:\n\n```\nmiipa/\n├── app/\n│   ├── setup/\n│   │   └── page.tsx              # セットアップ画面\n│   └── api/\n│       └── setup/\n│           ├── validate-key/     # APIキー検証エンドポイント\n│           └── save-settings/    # 設定保存エンドポイント\n├── components/\n│   └── setup/                    # セットアップ関連コンポーネント\n├── lib/\n│   ├── application/\n│   │   └── setup/               # セットアップユースケース\n│   └── infrastructure/\n│       └── keychain/            # Keychain統合（既存）\n```\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\nproject-setupで実装済みの基盤を最大限活用する:\n\n| コンポーネント | 場所 | 活用方法 |\n|--------------|------|---------|\n| **Result型** | `lib/domain/shared/result.ts` | 全操作のエラーハンドリング |\n| **Option型** | `lib/domain/shared/option.ts` | APIキーの存在確認 |\n| **エラー型** | `lib/domain/shared/errors.ts` | KeychainError, ConfigError |\n| **Keychain統合** | `lib/infrastructure/keychain/` | APIキーの保存・取得・存在確認 |\n| **設定管理** | `lib/config/` | 設定ファイルの読み書き |\n\n### Integration Points\n\n- **Keychain**: `setSecret`, `getSecret`, `hasSecret` でAPIキー管理\n- **設定ファイル**: `loadOrInitializeConfig`, `saveConfig` で設定永続化\n- **SecretKey型**: `anthropic-api-key`, `openai-api-key`, `ollama-api-key`\n- **LLMConfig型**: `provider`, `model`, `apiKeyRef`, `baseUrl`\n\n## Architecture\n\n### アーキテクチャ概要\n\nセットアップフローは、React Server Components + API Routes + 既存インフラ層の組み合わせで実装する。\n\n```mermaid\ngraph TB\n    subgraph \"プレゼンテーション層\"\n        SetupPage[\"/setup ページ\"]\n        ProviderSelect[プロバイダ選択]\n        KeyInput[APIキー入力]\n        Complete[完了画面]\n    end\n\n    subgraph \"API Routes\"\n        ValidateAPI[\"/api/setup/validate-key\"]\n        SaveAPI[\"/api/setup/save-settings\"]\n        CheckAPI[\"/api/setup/check-status\"]\n    end\n\n    subgraph \"アプリケーション層\"\n        ValidateKeyUC[ValidateApiKeyUseCase]\n        SaveSettingsUC[SaveSetupSettingsUseCase]\n        CheckSetupUC[CheckSetupStatusUseCase]\n    end\n\n    subgraph \"インフラ層（既存）\"\n        Keychain[Keychain<br/>getSecret / setSecret / hasSecret]\n        Config[Config<br/>loadOrInitializeConfig / saveConfig]\n    end\n\n    subgraph \"外部サービス\"\n        Claude[Anthropic API]\n        OpenAI[OpenAI API]\n        Ollama[Ollama Server]\n    end\n\n    SetupPage --> ProviderSelect\n    ProviderSelect --> KeyInput\n    KeyInput --> Complete\n\n    KeyInput --> ValidateAPI\n    Complete --> SaveAPI\n    SetupPage --> CheckAPI\n\n    ValidateAPI --> ValidateKeyUC\n    SaveAPI --> SaveSettingsUC\n    CheckAPI --> CheckSetupUC\n\n    ValidateKeyUC --> Claude\n    ValidateKeyUC --> OpenAI\n    ValidateKeyUC --> Ollama\n\n    SaveSettingsUC --> Keychain\n    SaveSettingsUC --> Config\n\n    CheckSetupUC --> Keychain\n    CheckSetupUC --> Config\n```\n\n### セットアップフロー\n\n```mermaid\nstateDiagram-v2\n    [*] --> CheckStatus: アプリ起動\n\n    CheckStatus --> ProviderSelection: 未設定\n    CheckStatus --> MainApp: 設定済み\n\n    state ProviderSelection {\n        [*] --> ShowProviders\n        ShowProviders --> ClaudeSelected: Claude選択\n        ShowProviders --> OpenAISelected: OpenAI選択\n        ShowProviders --> OllamaSelected: Ollama選択\n    }\n\n    ProviderSelection --> ApiKeyInput: Claude/OpenAI\n    ProviderSelection --> OllamaConnect: Ollama\n\n    state ApiKeyInput {\n        [*] --> ShowInput\n        ShowInput --> Validating: 検証ボタン\n        Validating --> ValidationSuccess: 成功\n        Validating --> ValidationError: 失敗\n        ValidationError --> ShowInput: 再入力\n    }\n\n    state OllamaConnect {\n        [*] --> CheckConnection\n        CheckConnection --> ConnectionSuccess: 接続成功\n        CheckConnection --> ConnectionError: 接続失敗\n        ConnectionError --> CheckConnection: リトライ\n    }\n\n    ApiKeyInput --> SaveSettings: 検証成功\n    OllamaConnect --> SaveSettings: 接続成功\n\n    state SaveSettings {\n        [*] --> SavingKeychain\n        SavingKeychain --> SavingConfig: Keychain保存成功\n        SavingConfig --> SaveComplete: Config保存成功\n        SavingKeychain --> SaveError: 保存失敗\n        SavingConfig --> SaveError: 保存失敗\n    }\n\n    SaveSettings --> Complete: 保存成功\n    SaveSettings --> ErrorDisplay: 保存失敗\n    ErrorDisplay --> SaveSettings: リトライ\n\n    Complete --> MainApp: 開始ボタン / 5秒後自動遷移\n\n    MainApp --> [*]\n```\n\n### Modular Design Principles\n\n- **Single File Responsibility**: 各コンポーネントは単一の明確な目的を持つ\n  - `ProviderCard.tsx`: プロバイダ選択カード\n  - `ApiKeyForm.tsx`: APIキー入力フォーム\n  - `SetupStepper.tsx`: ステップインジケータ\n- **Component Isolation**: 小さく焦点を絞ったコンポーネント\n  - 各ステップは独立したコンポーネント\n  - 状態管理はページレベルで統一\n- **Service Layer Separation**:\n  - UIコンポーネント → API Routes → アプリケーション層 → インフラ層\n\n## Components and Interfaces\n\n### Component 1: SetupPage (`app/setup/page.tsx`)\n\n**Purpose:** セットアップフローの統括ページ\n\n**Interfaces:**\n\n```typescript\n// ページコンポーネント（Server Component）\nexport default async function SetupPage(): Promise<JSX.Element>;\n\n// クライアント側状態管理\ninterface SetupState {\n  currentStep: 'provider' | 'key' | 'complete';\n  selectedProvider: LLMProvider | null;\n  isValidated: boolean;\n  isExistingSetup: boolean;  // 設定変更モードかどうか\n}\n```\n\n**Dependencies:**\n- `@/lib/config/loader` - `loadOrInitializeConfig`\n- `@/lib/infrastructure/keychain` - `hasSecret`\n- 子コンポーネント群\n\n**Reuses:**\n- `lib/config/types.ts` - `LLMProvider`, `AppConfig`\n- `lib/infrastructure/keychain/types.ts` - `SecretKey`\n\n### Component 2: ProviderSelector (`components/setup/ProviderSelector.tsx`)\n\n**Purpose:** LLMプロバイダ選択UI\n\n**Interfaces:**\n\n```typescript\ninterface ProviderSelectorProps {\n  selectedProvider: LLMProvider | null;\n  currentProvider?: LLMProvider;  // 既存設定（変更モード時）\n  onSelect: (provider: LLMProvider) => void;\n  disabled?: boolean;\n}\n\ninterface ProviderOption {\n  id: LLMProvider;\n  name: string;\n  description: string;\n  icon: React.ReactNode;\n  isRecommended: boolean;\n  requiresApiKey: boolean;\n}\n```\n\n**Dependencies:**\n- Park UI: `Card`, `Text`, `Badge`\n- Panda CSS: スタイリング\n\n**Reuses:**\n- `lib/config/types.ts` - `LLMProvider`\n\n### Component 3: ApiKeyForm (`components/setup/ApiKeyForm.tsx`)\n\n**Purpose:** APIキー入力・検証UI\n\n**Interfaces:**\n\n```typescript\ninterface ApiKeyFormProps {\n  provider: LLMProvider;\n  onValidated: (isValid: boolean) => void;\n  onKeyChange: (key: string) => void;\n}\n\ninterface ValidationState {\n  status: 'idle' | 'validating' | 'success' | 'error';\n  errorMessage?: string;\n}\n\n// APIキー検証関数の型\ntype ValidateApiKey = (\n  provider: LLMProvider,\n  apiKey: string\n) => Promise<Result<void, ApiKeyValidationError>>;\n```\n\n**Dependencies:**\n- Park UI: `Input`, `Button`, `Alert`, `Spinner`\n- `@/lib/domain/shared` - Result型\n\n**Reuses:**\n- `lib/config/types.ts` - `LLMProvider`\n- `lib/domain/shared/result.ts` - `Result`, `isOk`, `isErr`\n\n### Component 4: OllamaConnector (`components/setup/OllamaConnector.tsx`)\n\n**Purpose:** Ollama接続確認UI\n\n**Interfaces:**\n\n```typescript\ninterface OllamaConnectorProps {\n  onConnected: () => void;\n  defaultUrl?: string;\n}\n\ninterface OllamaConnectionState {\n  url: string;\n  status: 'idle' | 'connecting' | 'connected' | 'error';\n  errorMessage?: string;\n  availableModels?: string[];\n}\n```\n\n**Dependencies:**\n- Park UI: `Input`, `Button`, `Alert`, `Select`\n\n### Component 5: SetupStepper (`components/setup/SetupStepper.tsx`)\n\n**Purpose:** セットアップ進捗インジケータ\n\n**Interfaces:**\n\n```typescript\ninterface SetupStepperProps {\n  currentStep: number;\n  totalSteps: number;\n  steps: StepInfo[];\n}\n\ninterface StepInfo {\n  label: string;\n  description?: string;\n}\n```\n\n**Dependencies:**\n- Park UI: `Steps` コンポーネント\n- Panda CSS: カスタムスタイリング\n\n### Component 6: SetupComplete (`components/setup/SetupComplete.tsx`)\n\n**Purpose:** セットアップ完了画面\n\n**Interfaces:**\n\n```typescript\ninterface SetupCompleteProps {\n  provider: LLMProvider;\n  onStart: () => void;\n  autoRedirectSeconds?: number;  // デフォルト: 5\n}\n```\n\n**Dependencies:**\n- Park UI: `Card`, `Button`, `Text`\n- ミーアキャットイラスト（SVG）\n\n### Component 7: ValidateApiKeyUseCase (`lib/application/setup/validate-api-key.ts`)\n\n**Purpose:** APIキーの検証ロジック\n\n**Interfaces:**\n\n```typescript\n// エラー型\ninterface ApiKeyValidationError {\n  code: 'INVALID_FORMAT' | 'API_ERROR' | 'TIMEOUT' | 'NETWORK_ERROR';\n  message: string;\n  cause?: unknown;\n}\n\n// 検証関数\nasync function validateApiKey(\n  provider: LLMProvider,\n  apiKey: string\n): Promise<Result<void, ApiKeyValidationError>>;\n\n// プロバイダ別検証\nasync function validateClaudeKey(apiKey: string): Promise<Result<void, ApiKeyValidationError>>;\nasync function validateOpenAIKey(apiKey: string): Promise<Result<void, ApiKeyValidationError>>;\nasync function validateOllamaConnection(baseUrl: string): Promise<Result<string[], ApiKeyValidationError>>;\n```\n\n**Dependencies:**\n- `lib/domain/shared/result.ts`\n- Anthropic SDK / OpenAI SDK（オプション）\n\n**Reuses:**\n- `lib/domain/shared/result.ts` - `ok`, `err`, `Result`\n- `lib/config/types.ts` - `LLMProvider`\n\n### Component 8: SaveSetupSettingsUseCase (`lib/application/setup/save-setup-settings.ts`)\n\n**Purpose:** セットアップ設定の保存ロジック\n\n**Interfaces:**\n\n```typescript\ninterface SetupSettings {\n  provider: LLMProvider;\n  apiKey?: string;        // Claude/OpenAI用\n  baseUrl?: string;       // Ollama用\n  model?: string;         // オプション\n}\n\n// 保存関数\nasync function saveSetupSettings(\n  settings: SetupSettings\n): Promise<Result<void, ConfigError | KeychainError>>;\n\n// 既存設定の上書き確認が必要な場合\ninterface SaveOptions {\n  overwriteExisting?: boolean;\n}\n```\n\n**Dependencies:**\n- `lib/infrastructure/keychain` - `setSecret`, `hasSecret`\n- `lib/config/loader` - `loadOrInitializeConfig`, `saveConfig`\n- `lib/domain/shared/result.ts`\n\n**Reuses:**\n- `lib/infrastructure/keychain/index.ts` - 全関数\n- `lib/config/loader.ts` - `loadOrInitializeConfig`, `saveConfig`\n- `lib/config/types.ts` - `AppConfig`, `LLMConfig`\n- `lib/domain/shared/errors.ts` - `ConfigError`, `KeychainError`\n\n### Component 9: CheckSetupStatusUseCase (`lib/application/setup/check-setup-status.ts`)\n\n**Purpose:** セットアップ状態の確認ロジック\n\n**Interfaces:**\n\n```typescript\ninterface SetupStatus {\n  isComplete: boolean;\n  currentProvider?: LLMProvider;\n  hasApiKey: boolean;\n}\n\n// 確認関数\nasync function checkSetupStatus(): Promise<Result<SetupStatus, ConfigError | KeychainError>>;\n\n// 初回起動検出\nasync function isFirstLaunch(): Promise<Result<boolean, ConfigError>>;\n```\n\n**Dependencies:**\n- `lib/infrastructure/keychain` - `hasSecret`\n- `lib/config/loader` - `configExists`, `loadConfig`\n\n**Reuses:**\n- `lib/infrastructure/keychain/index.ts` - `hasSecret`\n- `lib/config/loader.ts` - `configExists`, `loadConfig`\n- `lib/config/types.ts` - `LLMProvider`\n\n## Data Models\n\n### Model 1: SetupSettings（セットアップ設定）\n\n```typescript\n// lib/application/setup/types.ts\n\n/**\n * セットアップ時に入力される設定\n */\ninterface SetupSettings {\n  /** 選択されたLLMプロバイダ */\n  readonly provider: LLMProvider;\n\n  /** APIキー（Claude/OpenAI用） */\n  readonly apiKey?: string;\n\n  /** OllamaのベースURL */\n  readonly baseUrl?: string;\n\n  /** 使用するモデル（省略時はプロバイダデフォルト） */\n  readonly model?: string;\n}\n\n/**\n * セットアップの状態\n */\ninterface SetupStatus {\n  /** セットアップが完了しているか */\n  readonly isComplete: boolean;\n\n  /** 現在設定されているプロバイダ */\n  readonly currentProvider?: LLMProvider;\n\n  /** APIキーが設定されているか */\n  readonly hasApiKey: boolean;\n}\n```\n\n### Model 2: APIキー検証結果\n\n```typescript\n// lib/application/setup/types.ts\n\n/**\n * APIキー検証エラーコード\n */\ntype ApiKeyValidationErrorCode =\n  | 'INVALID_FORMAT'    // APIキーの形式が不正\n  | 'API_ERROR'         // API呼び出しエラー（認証失敗等）\n  | 'TIMEOUT'           // タイムアウト\n  | 'NETWORK_ERROR';    // ネットワークエラー\n\n/**\n * APIキー検証エラー\n */\ninterface ApiKeyValidationError {\n  readonly code: ApiKeyValidationErrorCode;\n  readonly message: string;\n  readonly cause?: unknown;\n}\n\n/**\n * Ollama接続結果\n */\ninterface OllamaConnectionResult {\n  readonly connected: boolean;\n  readonly availableModels: string[];\n  readonly version?: string;\n}\n```\n\n### Model 3: プロバイダ情報\n\n```typescript\n// components/setup/types.ts\n\n/**\n * プロバイダ表示情報\n */\ninterface ProviderInfo {\n  readonly id: LLMProvider;\n  readonly name: string;\n  readonly description: string;\n  readonly iconPath: string;\n  readonly isRecommended: boolean;\n  readonly requiresApiKey: boolean;\n  readonly apiKeyPattern?: RegExp;\n  readonly apiKeyHelpUrl?: string;\n}\n\n/**\n * プロバイダ情報の定数\n */\nconst PROVIDER_INFO: Record<LLMProvider, ProviderInfo> = {\n  claude: {\n    id: 'claude',\n    name: 'Claude (Anthropic)',\n    description: '高度な推論能力を持つAIアシスタント',\n    iconPath: '/icons/anthropic.svg',\n    isRecommended: true,\n    requiresApiKey: true,\n    apiKeyPattern: /^sk-ant-/,\n    apiKeyHelpUrl: 'https://console.anthropic.com/settings/keys',\n  },\n  openai: {\n    id: 'openai',\n    name: 'OpenAI (GPT)',\n    description: 'ChatGPTを支えるAIモデル',\n    iconPath: '/icons/openai.svg',\n    isRecommended: false,\n    requiresApiKey: true,\n    apiKeyPattern: /^sk-/,\n    apiKeyHelpUrl: 'https://platform.openai.com/api-keys',\n  },\n  ollama: {\n    id: 'ollama',\n    name: 'Ollama (ローカル)',\n    description: 'プライバシー重視のローカルAI',\n    iconPath: '/icons/ollama.svg',\n    isRecommended: false,\n    requiresApiKey: false,\n  },\n};\n```\n\n## API Routes\n\n### Route 1: POST /api/setup/validate-key\n\n**Purpose:** APIキーの検証\n\n**Request:**\n```typescript\ninterface ValidateKeyRequest {\n  provider: LLMProvider;\n  apiKey: string;\n}\n```\n\n**Response:**\n```typescript\n// 成功時\ninterface ValidateKeySuccessResponse {\n  valid: true;\n}\n\n// 失敗時\ninterface ValidateKeyErrorResponse {\n  valid: false;\n  error: {\n    code: ApiKeyValidationErrorCode;\n    message: string;\n  };\n}\n```\n\n### Route 2: POST /api/setup/save-settings\n\n**Purpose:** セットアップ設定の保存\n\n**Request:**\n```typescript\ninterface SaveSettingsRequest {\n  provider: LLMProvider;\n  apiKey?: string;\n  baseUrl?: string;\n  model?: string;\n  overwriteExisting?: boolean;\n}\n```\n\n**Response:**\n```typescript\n// 成功時\ninterface SaveSettingsSuccessResponse {\n  success: true;\n}\n\n// 失敗時\ninterface SaveSettingsErrorResponse {\n  success: false;\n  error: {\n    code: string;\n    message: string;\n  };\n}\n\n// 上書き確認が必要な場合\ninterface SaveSettingsConfirmResponse {\n  success: false;\n  requiresConfirmation: true;\n  existingProvider: LLMProvider;\n}\n```\n\n### Route 3: GET /api/setup/check-status\n\n**Purpose:** セットアップ状態の確認\n\n**Response:**\n```typescript\ninterface CheckStatusResponse {\n  isComplete: boolean;\n  currentProvider?: LLMProvider;\n  hasApiKey: boolean;\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n#### 1. APIキー形式エラー\n\n**Scenario:** ユーザーが不正な形式のAPIキーを入力\n\n**Handling:**\n```typescript\nfunction validateApiKeyFormat(provider: LLMProvider, apiKey: string): Result<void, ApiKeyValidationError> {\n  const pattern = PROVIDER_INFO[provider].apiKeyPattern;\n  if (pattern && !pattern.test(apiKey)) {\n    return err({\n      code: 'INVALID_FORMAT',\n      message: `${PROVIDER_INFO[provider].name}のAPIキー形式が正しくありません。`,\n    });\n  }\n  return ok(undefined);\n}\n```\n\n**User Impact:** 入力フィールドにエラーメッセージを表示し、正しい形式をガイド\n\n#### 2. API接続エラー\n\n**Scenario:** APIキー検証時にネットワークエラーが発生\n\n**Handling:**\n```typescript\nasync function validateWithTimeout<T>(\n  promise: Promise<T>,\n  timeoutMs: number = 3000\n): Promise<Result<T, ApiKeyValidationError>> {\n  try {\n    const result = await Promise.race([\n      promise,\n      new Promise<never>((_, reject) =>\n        setTimeout(() => reject(new Error('Timeout')), timeoutMs)\n      ),\n    ]);\n    return ok(result);\n  } catch (error) {\n    if (error instanceof Error && error.message === 'Timeout') {\n      return err({\n        code: 'TIMEOUT',\n        message: '接続がタイムアウトしました。ネットワーク接続を確認してください。',\n        cause: error,\n      });\n    }\n    return err({\n      code: 'NETWORK_ERROR',\n      message: 'ネットワークエラーが発生しました。インターネット接続を確認してください。',\n      cause: error,\n    });\n  }\n}\n```\n\n**User Impact:** エラーメッセージと「再試行」ボタンを表示\n\n#### 3. Keychainアクセス拒否\n\n**Scenario:** macOSのセキュリティ設定によりKeychainへのアクセスが拒否\n\n**Handling:**\n```typescript\nconst saveResult = await setSecret('anthropic-api-key', apiKey);\nmatch(saveResult, {\n  ok: () => { /* 成功処理 */ },\n  err: (error) => {\n    if (error.code === 'KEYCHAIN_ACCESS_DENIED') {\n      showKeychainPermissionDialog();\n    } else {\n      showGenericError(error.message);\n    }\n  },\n});\n```\n\n**User Impact:** システム環境設定の開き方を案内するダイアログを表示\n\n#### 4. Ollama接続エラー\n\n**Scenario:** Ollamaサーバーが起動していない\n\n**Handling:**\n```typescript\nasync function validateOllamaConnection(baseUrl: string): Promise<Result<OllamaConnectionResult, ApiKeyValidationError>> {\n  try {\n    const response = await fetch(`${baseUrl}/api/tags`);\n    if (!response.ok) {\n      return err({\n        code: 'API_ERROR',\n        message: 'Ollamaサーバーに接続できませんでした。Ollamaが起動しているか確認してください。',\n      });\n    }\n    const data = await response.json();\n    return ok({\n      connected: true,\n      availableModels: data.models?.map((m: { name: string }) => m.name) ?? [],\n    });\n  } catch (error) {\n    return err({\n      code: 'NETWORK_ERROR',\n      message: 'Ollamaサーバーに接続できません。`ollama serve`でサーバーを起動してください。',\n      cause: error,\n    });\n  }\n}\n```\n\n**User Impact:** Ollamaの起動方法を案内するメッセージを表示\n\n### エラーメッセージガイドライン\n\n| エラーコード | 日本語メッセージ | アクション |\n|------------|----------------|----------|\n| INVALID_FORMAT | APIキーの形式が正しくありません | 正しい形式を案内 |\n| API_ERROR | APIキーが無効です | 再入力を促す |\n| TIMEOUT | 接続がタイムアウトしました | 再試行ボタン |\n| NETWORK_ERROR | ネットワークエラーが発生しました | 接続確認を案内 |\n| KEYCHAIN_ACCESS_DENIED | Keychainへのアクセスが拒否されました | 設定方法を案内 |\n| KEYCHAIN_WRITE_FAILED | 認証情報の保存に失敗しました | リトライボタン |\n\n## UI/UX Design\n\n### 画面遷移\n\n```mermaid\ngraph LR\n    A[\"/ (メイン)\"] -->|未設定| B[\"/setup\"]\n    B --> C[\"Step 1: プロバイダ選択\"]\n    C --> D[\"Step 2: APIキー入力\"]\n    C --> E[\"Step 2: Ollama接続\"]\n    D --> F[\"Step 3: 完了\"]\n    E --> F\n    F -->|開始ボタン| A\n    F -->|5秒後| A\n\n    B -->|設定済みアクセス| G[\"設定変更モード\"]\n    G --> C\n```\n\n### コンポーネント配置\n\n```\n┌─────────────────────────────────────────────────────────────┐\n│  miipa セットアップ                                        │\n├─────────────────────────────────────────────────────────────┤\n│                                                             │\n│  ┌─────────────────────────────────────────────────────┐   │\n│  │  [●] ─────────── [○] ─────────── [○]                │   │\n│  │  プロバイダ選択    APIキー入力      完了               │   │\n│  └─────────────────────────────────────────────────────┘   │\n│                                                             │\n│  ┌─────────────────────────────────────────────────────┐   │\n│  │                                                       │   │\n│  │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │   │\n│  │   │  [Claude]   │  │  [OpenAI]   │  │  [Ollama]   │ │   │\n│  │   │   ★推奨     │  │             │  │  ローカル   │ │   │\n│  │   │             │  │             │  │             │ │   │\n│  │   └─────────────┘  └─────────────┘  └─────────────┘ │   │\n│  │                                                       │   │\n│  └─────────────────────────────────────────────────────┘   │\n│                                                             │\n│                              [ 次へ → ]                     │\n│                                                             │\n└─────────────────────────────────────────────────────────────┘\n```\n\n### Park UI コンポーネント使用計画\n\n| UI要素 | Park UIコンポーネント | カスタマイズ |\n|--------|---------------------|------------|\n| ステップインジケータ | `Steps` | 3ステップ固定 |\n| プロバイダカード | `Card` + `RadioGroup` | アイコン・バッジ付き |\n| APIキー入力 | `Input` (type=\"password\") | 表示/非表示トグル |\n| 検証ボタン | `Button` | ローディング状態 |\n| エラー表示 | `Alert` (variant=\"error\") | アイコン付き |\n| 成功表示 | `Alert` (variant=\"success\") | チェックマーク |\n| ヘルプリンク | `Link` | 外部リンクアイコン |\n| 完了画面 | `Card` | ミーアキャットイラスト |\n\n### アクセシビリティ要件\n\n- キーボードナビゲーション: Tab/Shift+Tab で全要素にアクセス可能\n- Enterキー: フォーム送信、次へ進む\n- Escapeキー: 設定変更モードからキャンセル\n- スクリーンリーダー対応: 適切なaria-label, aria-describedby\n- コントラスト比: WCAG AA準拠（4.5:1以上）\n\n## Testing Strategy\n\n### Unit Testing\n\n**対象:**\n- `lib/application/setup/validate-api-key.ts` - APIキー検証ロジック\n- `lib/application/setup/save-setup-settings.ts` - 保存ロジック\n- `lib/application/setup/check-setup-status.ts` - 状態確認ロジック\n- 各コンポーネントの純粋関数\n\n**テスト例:**\n```typescript\n// validate-api-key.test.ts\nimport { describe, it, expect } from 'vitest';\nimport { validateApiKeyFormat } from './validate-api-key';\nimport { isOk, isErr } from '@/lib/domain/shared';\n\ndescribe('validateApiKeyFormat', () => {\n  it('Claude APIキーの形式が正しい場合はOkを返す', () => {\n    const result = validateApiKeyFormat('claude', 'sk-ant-api03-xxxxx');\n    expect(isOk(result)).toBe(true);\n  });\n\n  it('Claude APIキーの形式が不正な場合はErrを返す', () => {\n    const result = validateApiKeyFormat('claude', 'invalid-key');\n    expect(isErr(result)).toBe(true);\n    if (isErr(result)) {\n      expect(result.error.code).toBe('INVALID_FORMAT');\n    }\n  });\n\n  it('OpenAI APIキーの形式が正しい場合はOkを返す', () => {\n    const result = validateApiKeyFormat('openai', 'sk-xxxxx');\n    expect(isOk(result)).toBe(true);\n  });\n});\n```\n\n### Integration Testing\n\n**対象:**\n- API Routes: `/api/setup/*`\n- Keychain統合（モック使用）\n- 設定ファイル操作（テスト用ディレクトリ）\n\n**テスト例:**\n```typescript\n// api/setup/validate-key.test.ts\nimport { describe, it, expect, vi } from 'vitest';\nimport { POST } from './route';\n\ndescribe('POST /api/setup/validate-key', () => {\n  it('有効なAPIキーの場合は valid: true を返す', async () => {\n    // Anthropic APIをモック\n    vi.mock('@anthropic-ai/sdk', () => ({\n      default: vi.fn().mockImplementation(() => ({\n        messages: {\n          create: vi.fn().mockResolvedValue({ id: 'msg_xxx' }),\n        },\n      })),\n    }));\n\n    const request = new Request('http://localhost/api/setup/validate-key', {\n      method: 'POST',\n      body: JSON.stringify({\n        provider: 'claude',\n        apiKey: 'sk-ant-api03-test',\n      }),\n    });\n\n    const response = await POST(request);\n    const data = await response.json();\n\n    expect(data.valid).toBe(true);\n  });\n});\n```\n\n### End-to-End Testing\n\n**対象:**\n- 初回起動フロー全体\n- プロバイダ選択 → APIキー入力 → 完了\n- 設定変更フロー\n- エラーケース（無効なAPIキー、ネットワークエラー）\n\n**テストシナリオ:**\n\n1. **初回起動テスト**\n   - アプリ起動 → /setup にリダイレクトされる\n   - Claude を選択 → APIキー入力画面に遷移\n   - 有効なAPIキー入力 → 検証成功\n   - 保存 → 完了画面表示\n   - 「開始」クリック → / にリダイレクト\n\n2. **設定変更テスト**\n   - 設定済み状態で /setup にアクセス\n   - 現在の設定が表示される\n   - 別プロバイダを選択\n   - 新しいAPIキー入力 → 保存\n   - 設定が更新される\n\n3. **エラーハンドリングテスト**\n   - 無効なAPIキー入力 → エラーメッセージ表示\n   - ネットワーク切断状態 → 適切なエラー表示\n   - Keychainアクセス拒否 → 案内表示\n\n## Directory Structure\n\n最終的なディレクトリ構成:\n\n```\nmiipa/\n├── app/\n│   ├── setup/\n│   │   ├── page.tsx                    # セットアップページ (Server Component)\n│   │   └── layout.tsx                  # セットアップ用レイアウト\n│   └── api/\n│       └── setup/\n│           ├── validate-key/\n│           │   └── route.ts            # APIキー検証エンドポイント\n│           ├── save-settings/\n│           │   └── route.ts            # 設定保存エンドポイント\n│           └── check-status/\n│               └── route.ts            # 状態確認エンドポイント\n├── components/\n│   └── setup/\n│       ├── index.ts                    # 公開エクスポート\n│       ├── types.ts                    # コンポーネント用型定義\n│       ├── ProviderSelector.tsx        # プロバイダ選択\n│       ├── ProviderCard.tsx            # プロバイダカード\n│       ├── ApiKeyForm.tsx              # APIキー入力フォーム\n│       ├── OllamaConnector.tsx         # Ollama接続確認\n│       ├── SetupStepper.tsx            # ステップインジケータ\n│       ├── SetupComplete.tsx           # 完了画面\n│       └── SetupClientWrapper.tsx      # クライアント状態管理\n├── lib/\n│   ├── application/\n│   │   └── setup/\n│   │       ├── index.ts                # 公開エクスポート\n│   │       ├── types.ts                # アプリケーション層型定義\n│   │       ├── validate-api-key.ts     # APIキー検証ユースケース\n│   │       ├── save-setup-settings.ts  # 設定保存ユースケース\n│   │       └── check-setup-status.ts   # 状態確認ユースケース\n│   ├── config/                         # (既存)\n│   ├── domain/\n│   │   └── shared/                     # (既存)\n│   └── infrastructure/\n│       └── keychain/                   # (既存)\n└── public/\n    └── icons/\n        ├── anthropic.svg               # Anthropicロゴ\n        ├── openai.svg                  # OpenAIロゴ\n        └── ollama.svg                  # Ollamaロゴ\n```\n\n## Implementation Notes\n\n### 初回起動検出ロジック\n\n```typescript\n// app/layout.tsx または middleware.ts で実装\nasync function shouldRedirectToSetup(): Promise<boolean> {\n  // 1. 設定ファイルの存在確認\n  const configResult = await loadConfig();\n\n  if (isErr(configResult)) {\n    if (configResult.error.code === 'CONFIG_NOT_FOUND') {\n      return true; // 設定ファイルがない → セットアップへ\n    }\n    // その他のエラーは設定済みとして扱う（エラー画面で対応）\n    return false;\n  }\n\n  const config = configResult.value;\n\n  // 2. プロバイダに応じたAPIキーの存在確認\n  const secretKey = getSecretKeyForProvider(config.llm.provider);\n  if (secretKey) {\n    const hasKeyResult = await hasSecret(secretKey);\n    if (isOk(hasKeyResult) && !hasKeyResult.value) {\n      return true; // APIキーがない → セットアップへ\n    }\n  }\n\n  return false; // 設定完了済み\n}\n\nfunction getSecretKeyForProvider(provider: LLMProvider): SecretKey | null {\n  switch (provider) {\n    case 'claude': return 'anthropic-api-key';\n    case 'openai': return 'openai-api-key';\n    case 'ollama': return 'ollama-api-key';\n    default: return null;\n  }\n}\n```\n\n### APIキー検証の実装方針\n\nAPIキー検証は、可能な限り軽量なAPI呼び出しで行う:\n\n- **Claude**: `/v1/messages` に最小限のリクエストを送信（トークン消費を最小化）\n- **OpenAI**: `/v1/models` エンドポイントで認証確認（無料）\n- **Ollama**: `/api/tags` でサーバー接続とモデル一覧を取得\n\n```typescript\n// Claude検証例\nasync function validateClaudeKey(apiKey: string): Promise<Result<void, ApiKeyValidationError>> {\n  try {\n    const response = await fetch('https://api.anthropic.com/v1/messages', {\n      method: 'POST',\n      headers: {\n        'x-api-key': apiKey,\n        'anthropic-version': '2023-06-01',\n        'content-type': 'application/json',\n      },\n      body: JSON.stringify({\n        model: 'claude-3-haiku-20240307', // 最も安価なモデル\n        max_tokens: 1,\n        messages: [{ role: 'user', content: 'Hi' }],\n      }),\n    });\n\n    if (response.status === 401) {\n      return err({\n        code: 'API_ERROR',\n        message: 'APIキーが無効です。正しいキーを入力してください。',\n      });\n    }\n\n    if (!response.ok) {\n      return err({\n        code: 'API_ERROR',\n        message: `API接続エラー: ${response.status}`,\n      });\n    }\n\n    return ok(undefined);\n  } catch (error) {\n    return err({\n      code: 'NETWORK_ERROR',\n      message: 'ネットワークエラーが発生しました。',\n      cause: error,\n    });\n  }\n}\n```\n\n### セキュリティ考慮事項\n\n1. **APIキーの取り扱い**\n   - クライアントサイドではAPIキーをStateに一時保持\n   - 検証成功後、即座にAPI Routeへ送信してKeychainに保存\n   - 保存後はクライアント側のStateをクリア\n   - ログ出力時にAPIキーをマスク\n\n2. **API Routes保護**\n   - CSRF対策としてOriginヘッダーの検証\n   - レート制限の実装（連続した検証リクエストを制限）\n\n3. **通信**\n   - すべてのAPI通信はHTTPS経由\n   - ローカルホスト以外からのアクセスを拒否\n",
	"fileStats": {
		"size": 34192,
		"lines": 1113,
		"lastModified": "2026-01-26T02:48:15.860Z"
	},
	"comments": []
}
